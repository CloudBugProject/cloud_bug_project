{% extends 'base.html' %}
{% block content %}

<div class="row">
  <div class="col-12">
    <div class="card cyber-card">
      <div class="card-header">
        <h3><i class="fas fa-upload"></i> Threat Analysis Upload</h3>
      </div>
      <div class="card-body">
        <form id="uploadForm" method="post" enctype="multipart/form-data" action="{{ url_for('upload') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          
          <div class="file-upload-area" id="uploadArea">
            <div class="visual-content">
              <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
              <h4>Drop your CSV file here or click to browse</h4>
              <p class="text-muted">Supported formats: CSV with network traffic data (Max: 500MB)</p>
              <div class="alert alert-info cyber-alert mt-3">
                <h6><i class="fas fa-info-circle"></i> Supported Column Formats:</h6>
                <ul class="mb-0">
                  <li><strong>Duration:</strong> dur, duration, Flow Duration</li>
                  <li><strong>Protocol:</strong> proto, protocol, protocol_type</li>
                  <li><strong>Source Bytes:</strong> sbytes, src_bytes, Total Length of Fwd Packets</li>
                  <li><strong>Destination Bytes:</strong> dbytes, dst_bytes, Total Length of Bwd Packets</li>
                  <li><strong>Label:</strong> label, attack_cat, is_malicious</li>
                </ul>
              </div>
              
              <div class="mt-3">
                <button type="button" class="btn btn-outline-cyber btn-lg" id="chooseFileBtn" onclick="openFileDialog()">
                  <i class="fas fa-folder-open"></i> BROWSE FILES
                </button>
              </div>
            </div>
            
            <!-- Hidden file input -->
            <input type="file" name="file" accept=".csv" id="fileInput" style="display: none;">
          </div>
          
          <div id="fileInfo" class="mt-3" style="display: none;">
            <div class="alert alert-info cyber-alert">
              <i class="fas fa-file-csv"></i>
              <span id="fileName"></span>
              <button type="button" class="btn-close" onclick="clearFile()"></button>
            </div>
          </div>
          
          <div class="text-center mt-3">
            {% if session.get('user_email') %}
              <button class="btn btn-primary btn-lg" type="submit" id="uploadBtn" disabled>
                <i class="fas fa-rocket"></i> ANALYZE THREATS
              </button>
            {% else %}
              <button class="btn btn-primary btn-lg" type="button" id="uploadBtn" disabled title="로그인 후 이용 가능합니다">
                <i class="fas fa-rocket"></i> ANALYZE THREATS (로그인 필요)
              </button>
            {% endif %}
          </div>
    </div>
  </div>
</div>

<!-- Results Section -->
<div class="row mt-3">
  <div class="col-12">
    <div class="card cyber-card">
      <div class="card-header">
        <h5><i class="fas fa-layer-group"></i> Attack Class Distribution</h5>
      </div>
      <div class="card-body" style="height: 260px;">
        <canvas id="classBar"></canvas>
      </div>
    </div>
  </div>
</div>
<div class="row mt-4" id="resultsSection" style="display: none;">
  <div class="col-12">
    <div class="card cyber-card">
      <div class="card-header">
        <h3><i class="fas fa-chart-bar"></i> Analysis Results</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card cyber-card">
              <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Threat Distribution</h5>
              </div>
              <div class="card-body">
                <div id="pieWrap" style="height:260px">
                  <canvas id="pieChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card cyber-card">
              <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Top Malicious Entries</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm" id="malTable">
                    <thead>
                      <tr>
                        <th>Duration</th>
                        <th>Protocol</th>
                        <th>Src Bytes</th>
                        <th>Dst Bytes</th>
                        <th>Prediction</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center">
        <div class="loading mb-3"></div>
        <h5>Analyzing Threats...</h5>
        <p class="text-muted">Please wait while we process your data</p>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block scripts %}
<script>
  window.IS_AUTH = {{ (session.get('user_email') is not none) | tojson }};
  // ---------- Utils ----------
  const fmtNum = (v) => (typeof v === "number" && Number.isFinite(v) ? v.toLocaleString() : v);
  const safeVal = (v) => {
    if (v === null || v === undefined || v === "") return "N/A";
    if (typeof v === "number" && !Number.isFinite(v)) return "N/A";
    return v;
  };
  const protoMap = { 6: "tcp", 17: "udp", 1: "icmp" };
  const mapProto = (v) => {
    if (v === null || v === undefined) return "N/A";
    const n = Number(v);
    if (Number.isFinite(n)) return protoMap[n] ?? String(n);
    return String(v).toLowerCase();
  };

  // ---------- DOM refs ----------
  let fileInput, chooseFileBtn, fileInfo, fileName, uploadBtn, resultsSection, loadingModal;

  // ---------- File dialog ----------
  function openFileDialog() {
    if (fileInput) fileInput.click();
  }
  window.openFileDialog = openFileDialog; // 전역 노출

  function handleFileSelect(file) {
    if (!file) return;
    if (fileName) fileName.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    if (fileInfo) fileInfo.style.display = 'block';
    if (uploadBtn) uploadBtn.disabled = false;

    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
      const visualContent = uploadArea.querySelector('.visual-content');
      if (visualContent) visualContent.remove();
      const newVisual = document.createElement('div');
      newVisual.className = 'visual-content';
      newVisual.innerHTML = `
        <i class="fas fa-file-csv fa-3x mb-3 text-success"></i>
        <h4>File Selected: ${file.name}</h4>
        <p class="text-muted">Size: ${(file.size/1024).toFixed(1)} KB</p>
        <div class="mt-3">
          <button type="button" class="btn btn-outline-cyber btn-lg" onclick="openFileDialog()">
            <i class="fas fa-folder-open"></i> CHOOSE DIFFERENT FILE
          </button>
        </div>`;
      uploadArea.appendChild(newVisual);
    }
    showNotification(`File "${file.name}" selected successfully!`, 'success');
  }

  function clearFile() {
    if (fileInput) fileInput.value = '';
    if (fileInfo) fileInfo.style.display = 'none';
    if (uploadBtn) uploadBtn.disabled = true;
  }


  // ---------- Results render ----------
  window.pieChart = null;
  window.classBarChart = null;

  function displayResults(data) {
    // 1) Pie/Doughnut
    // try { if (window.pieChart?.destroy) window.pieChart.destroy(); } catch {}
    // const pieEl = document.getElementById('pieChart');
    // if (pieEl && typeof Chart !== 'undefined') {
    //   const normal = Number(data?.normal) || 0;
    //   const malicious = Number(data?.malicious) || 0;
    //   const total = normal + malicious;
    //   window.pieChart = new Chart(pieEl, {
    //     type: 'doughnut',
    //     data: {
    //       labels: ['Normal', 'Malicious'],
    //       datasets: [{ data: [normal, malicious], backgroundColor: ['#00ff41', '#ff0040'] }]
    //     },
    //     options: {
    //       responsive: true,
    //       maintainAspectRatio: false,
    //       plugins: {
    //         tooltip: { callbacks: { label: (ctx) => {
    //           const val = ctx.raw ?? 0;
    //           const pct = total ? ((val/total)*100).toFixed(1) : '0.0';
    //           return `${ctx.label}: ${fmtNum(val)} (${pct}%)`;
    //         }}},
    //         legend: { labels: { color: '#00ff41' } }
    //       }
    //     }
    //   });
    // }
    // 1)pie chart 파이 차트 - Malicious 타입별 분류 (malicious_details 사용)
    try {
        if (window.pieChart?.destroy) window.pieChart.destroy();
        
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        
        let pieData, pieTitle;
        
        // malicious_details가 있고 내용이 있으면 상세 분류 표시 (기존 구조 호환)
        if (data.malicious_details && Object.keys(data.malicious_details).length > 0) {
            const labels = Object.keys(data.malicious_details);
            const values = Object.values(data.malicious_details);
            
            // 컬러 팔레트
            const colors = [
                'rgba(255, 99, 132, 0.8)',   // 빨간색
                'rgba(54, 162, 235, 0.8)',   // 파란색
                'rgba(255, 205, 86, 0.8)',   // 노란색
                'rgba(75, 192, 192, 0.8)',   // 청록색
                'rgba(153, 102, 255, 0.8)',  // 보라색
                'rgba(255, 159, 64, 0.8)',   // 주황색
                'rgba(199, 199, 199, 0.8)',  // 회색
                'rgba(83, 102, 255, 0.8)',   // 인디고
                'rgba(255, 99, 255, 0.8)',   // 핑크
                'rgba(99, 255, 132, 0.8)'    // 라임
            ];
            
            pieData = {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: colors.slice(0, labels.length).map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            };
            
            const totalMalicious = data.malicious_count || data.malicious || 0;
            pieTitle = `악성 트래픽 유형별 분포 (총 ${totalMalicious}개)`;
            
        } else {
            // malicious_details가 없으면 Normal vs Malicious 이진 분류
            const normalCount = data.normal_count || data.normal || 0;
            const maliciousCount = data.malicious_count || data.malicious || 0;
            
            pieData = {
                labels: ['Normal', 'Malicious'],
                datasets: [{
                    data: [normalCount, maliciousCount],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 2
                }]
            };
            
            pieTitle = '전체 트래픽 분포';
        }

        window.pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: pieData,
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: pieTitle,
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('파이 차트 생성 오류:', error);
    }

    // 2) Class bar
    let byClass = (data && typeof data.by_class === 'object') ? data.by_class : null;
    if (!byClass && Array.isArray(data?.top_malicious)) {
      byClass = {};
      for (const r of data.top_malicious) {
        const k = String(r.prediction ?? 'Malicious');
        byClass[k] = (byClass[k] ?? 0) + 1;
      }
      if (typeof data.normal === 'number') {
        byClass['Benign'] = (byClass['Benign'] ?? 0) + Number(data.normal);
      }
    }
    if (!byClass && typeof data.normal === 'number' && typeof data.malicious === 'number') {
      byClass = { Benign: Number(data.normal), Malicious: Number(data.malicious) };
    }

    try { if (window.classBarChart?.destroy) window.classBarChart.destroy(); } catch {}
    const barEl = document.getElementById('classBar');
    if (barEl && typeof data.normal === 'number' && typeof data.malicious === 'number' && typeof Chart !== 'undefined') {
      window.classBarChart = new Chart(barEl, {
        type: 'bar',
        data: {
          labels: ['Normal', 'Malicious'],
          datasets: [{ 
            label: 'Count', 
            data: [data.normal, data.malicious], 
            backgroundColor: ['#0066ff', '#ff0040'] // 파란색(Normal), 빨간색(Malicious)
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#00ff41' } },
            y: { ticks: { color: '#00ff41' } }
          }
        }
      });
    }

    // 3) Top malicious table
    const tbody = document.querySelector('#malTable tbody');
    if (tbody) {
      tbody.innerHTML = '';
      const list = Array.isArray(data?.top_malicious) ? data.top_malicious : [];
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No malicious entries found</td></tr>';
      } else {
        for (const r of list) {
          const duration = r.duration ?? 0;
          const protocol = r.protocol ?? "N/A";
          const sbytes   = r.src_bytes ?? 0;
          const dbytes   = r.dst_bytes ?? 0;
          const pred     = r.prediction ?? "unknown";
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${safeVal(duration)}</td>
            <td>${safeVal(protocol)}</td>
            <td>${fmtNum(sbytes)}</td>
            <td>${fmtNum(dbytes)}</td>
            <td>${safeVal(pred)}</td>`;
          tbody.appendChild(tr);
        }
      }
    }

    // show section
    if (resultsSection) {
      resultsSection.style.display = 'block';
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
  }
  window.displayResults = displayResults; // 전역 노출

  // ---------- Notifications ----------
  function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} cyber-alert`;
    alertDiv.innerHTML = `
      <i class="fas fa-info-circle me-2"></i>${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    setTimeout(() => { try { new bootstrap.Alert(alertDiv).close(); } catch {} }, 3000);
  }

  // ---------- Init ----------
  function initializeElements() {
    fileInput = document.getElementById('fileInput');
    chooseFileBtn = document.getElementById('chooseFileBtn');
    fileInfo = document.getElementById('fileInfo');
    fileName = document.getElementById('fileName');
    uploadBtn = document.getElementById('uploadBtn');
    resultsSection = document.getElementById('resultsSection');
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
      });
    }
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
      uploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'));
      uploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length>0) handleFileSelect(e.dataTransfer.files[0]); });
    }

    const form = document.getElementById('uploadForm');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!window.IS_AUTH) {
          return showNotification('로그인이 필요합니다.', 'warning');
        }
        if (!fileInput?.files?.length) return showNotification('Please select a file first', 'warning');
        const file = fileInput.files[0];
        if (!file.name.toLowerCase().endsWith('.csv')) return showNotification('Please select a CSV file', 'warning');
        if (file.size > 500*1024*1024) return showNotification('File exceeds 500MB limit', 'warning');

        // 로딩 모달 표시
        loadingModal.show();
        
        try {
          const formData = new FormData(form);
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 150000);
          
          const res = await fetch('/upload', { 
            method: 'POST', 
            body: formData, 
            signal: controller.signal 
          });
          
          clearTimeout(timeout);
          
          let result;
          try { 
            result = await res.json(); 
          } catch { 
            showNotification('Server returned invalid response format', 'danger'); 
            return; 
          }
          
          if (res.ok) { 
            displayResults(result); 
            showNotification('Analysis completed successfully!', 'success'); 
          } else {
            let msg = result?.error || (res.status===401 ? '로그인이 필요합니다.' : res.status===500 ? '서버 오류가 발생했습니다.' : '업로드 실패');
            showNotification(msg, 'danger');
          }
        } catch (err) {
          if (err.name === 'AbortError') {
            showNotification('Request timeout - please try again', 'warning');
          } else {
            showNotification('Network error occurred', 'danger');
          }
        } finally {
          // 로딩 모달 숨기기 - 모든 경우에 확실히 숨김
          try {
            // 포커스가 모달 안에 남아있으면 aria-hidden 변경이 막힙니다.
            if (document.activeElement && document.activeElement.closest('.modal')) {
              document.activeElement.blur();
            }
            loadingModal.hide();
          } catch (e) {
            // 강제로 모달 숨기기
            const modalElement = document.getElementById('loadingModal');
            if (modalElement) {
              modalElement.classList.remove('show');
              modalElement.style.display = 'none';
              document.body.classList.remove('modal-open');
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) backdrop.remove();
            }
          }
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializeElements();
    const authWarning = document.querySelector('.alert-warning');
    if (authWarning) showNotification('Please log in to use the threat analysis features', 'info');
  });
</script>

{% endblock %}

